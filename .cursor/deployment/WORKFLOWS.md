# Workflows — Автоматизированные процессы Нейрона

Описание всех автоматизированных workflows бота.

---

## 📰 Новостной дайджест

### Расписание (местное время)

| Местное время | Тип                  |
| ------------- | -------------------- |
| 08:00         | 🌅 Утренний дайджест |
| 13:00         | ☀️ Дневной дайджест  |
| 18:00         | 🌆 Вечерний дайджест |

> **Автоадаптация:** cron jobs выставляются в UTC, пересчитываются
> при смене часового пояса пользователя. Текущий TZ берётся из
> `MEMORY.md` → "Текущий timezone". При переезде или путешествии
> пользователь сообщает новый TZ → бот пересоздаёт cron jobs.

### Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    CRON TRIGGER (02:00/09:00/14:00 UTC)          │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. ДЕДУПЛИКАЦИЯ                                                │
│     - Прочитать data/sent-digests.json                          │
│     - Загрузить список отправленных за 7 дней                   │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. WEB SEARCH (Brave API)                                      │
│     - 7 категорий по приоритету                                 │
│     - Ключевые слова из news-config.md                          │
│     - Фильтр: пропустить URL/заголовки из sent-digests.json     │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. MULTI-ARMED BANDIT SELECTION                                │
│     - 70% проверенные источники (proven)                        │
│     - 30% новые источники (exploration)                         │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. DUAL RATING FILTER                                          │
│     - Рейтинг источников (proven/candidate/rejected)            │
│     - Рейтинг экспертов                                         │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. TELEGRAM DELIVERY                                           │
│     - Каждая новость = отдельное сообщение                      │
│     - Оценка через нативные реакции Telegram                    │
│     - 10-15 новостей за дайджест                                │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. ЗАПИСАТЬ ОТПРАВЛЕННЫЕ                                       │
│     - Сохранить заголовки/URL/keywords в sent-digests.json      │
│     - Удалить записи старше 7 дней                              │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. FEEDBACK LOOP                                               │
│     - Пользователь ставит emoji-реакцию (🔥👍👎💩)              │
│     - Система обновляет рейтинг источника                       │
│     - Следующий дайджест учитывает оценки                       │
└─────────────────────────────────────────────────────────────────┘
```

### Категории (по приоритету)

1. 🤖 **ИИ** — AI, ML, LLM, нейросети
2. 💻 **Вайбкодинг** — инструменты, лайфхаки разработки
3. 🦾 **Робототехника** — роботы, автоматизация
4. ✈️ **eVTOL** — электроавиация, дроны
5. ⚡ **Технологии** — общие технологии
6. 💼 **Бизнес** — стартапы, финансирование
7. 💰 **Инвестиции** — IPO, венчур

### Система оценок (нативные реакции Telegram)

| Реакция        | Баллы | Эффект                           |
| -------------- | ----- | -------------------------------- |
| 🔥 Отлично     | +10   | Источник становится приоритетным |
| 👍 Нравится    | +5    | Источник получает бонус          |
| 👎 Не нравится | -3    | Источник понижается              |
| 💩 Мусор       | -5    | Источник может быть исключён     |

### Статусы источников

- **Proven** (7+ баллов) — используются в 70% случаев
- **Candidate** (-2 до 7) — используются в 30% (exploration)
- **Rejected** (<-2) — исключены из дайджестов

### Команда `/digest`

Внеочередной дайджест по требованию:

```
/digest
```

### Файлы системы

| Файл                       | Назначение                              |
| -------------------------- | --------------------------------------- |
| `digest-format-final.md`   | Формат сообщений + правила дедупликации |
| `news-config.md`           | Ключевые слова и категории              |
| `dual-rating-system.js`    | Система рейтинга                        |
| `multi-armed-bandit.js`    | Алгоритм выбора                         |
| `data/source-ratings.json` | Рейтинги источников                     |
| `data/user-feedback.json`  | История оценок                          |
| `data/sent-digests.json`   | Трекинг отправленных (дедупликация)     |

---

## 💬 Дайджест мнений

### Расписание (местное время)

| Местное время | Тип                |
| ------------- | ------------------ |
| 08:30         | 💬 Утренние мнения |
| 13:30         | 💬 Дневные мнения  |
| 18:30         | 💬 Вечерние мнения |

> Те же правила автоадаптации часового пояса, что и у новостного дайджеста.

### Отличия от новостного дайджеста

|            | Новости                     | Мнения                        |
| ---------- | --------------------------- | ----------------------------- |
| Контент    | Факты, события, анонсы      | Тейки, комментарии, аналитика |
| Источники  | Новостные СМИ, пресс-релизы | Блогеры, эксперты, Twitter/X  |
| Заголовок  | `📰 ДАЙДЖЕСТ`               | `💬 МНЕНИЯ И КОММЕНТАРИИ`     |
| Количество | 10-15                       | 8-12                          |
| Трекинг    | `digest: "morning"`         | `digest: "opinions"`          |

### Workflow

Идентичен новостному дайджесту (дедупликация → поиск → фильтр → доставка → запись),
но на этапе поиска ищутся мнения/комментарии вместо новостей:

```
┌─────────────────────────────────────────────────────────────────┐
│  ПОИСК МНЕНИЙ                                                  │
│  - Twitter/X посты экспертов                                    │
│  - Блоги (Substack, Medium, Хабр)                              │
│  - LinkedIn посты                                               │
│  - Подкасты (ключевые цитаты)                                  │
│  - Reddit/HN обсуждения                                        │
└─────────────────────────────────────────────────────────────────┘
```

### Файлы системы

| Файл                     | Назначение                                  |
| ------------------------ | ------------------------------------------- |
| `digest-format-final.md` | Формат + правила (раздел "Дайджест мнений") |
| `data/sent-digests.json` | Общий трекинг (тип `opinions`)              |

---

## 🧠 Система рефлексий

### Расписание

| Время             | Тип                | Описание               |
| ----------------- | ------------------ | ---------------------- |
| 20:30 ежедневно   | Двойная рефлексия  | Моя + с пользователем  |
| 20:30 воскресенье | Еженедельный отчёт | Аналитика недели       |
| 06:00 ежедневно   | План действий      | Из вчерашней рефлексии |

### Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    CRON TRIGGER (20:30)                         │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. МОЯ РЕФЛЕКСИЯ                                               │
│     - Что было хорошо в моей работе?                            │
│     - Что было плохо?                                           │
│     - Что буду делать иначе завтра?                             │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. РЕФЛЕКСИЯ С ПОЛЬЗОВАТЕЛЕМ                                   │
│     - Задаю 3 вопроса                                           │
│     - Записываю ответы                                          │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. СОХРАНЕНИЕ В ПАМЯТЬ                                         │
│     - memory/YYYY-MM-DD.md                                      │
│     - data/reflections.json                                     │
└─────────────────────────────────────────────────────────────────┘
```

### Еженедельная аналитика (воскресенье)

- Анализ трендов недели
- Статистика по темам
- Выводы и планы улучшения
- Отчёт пользователю

### Файлы системы

| Файл                    | Назначение        |
| ----------------------- | ----------------- |
| `reflection-system.md`  | Описание системы  |
| `REFLECTION-TASKS.md`   | Текущие задачи    |
| `data/reflections.json` | История рефлексий |

---

## 💓 Heartbeat (фоновые проверки)

### Интервал

- **Каждые 30 минут** (настраивается)
- **Active hours:** 08:00-24:00 (по умолчанию)

### Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    HEARTBEAT TRIGGER (каждые 30 мин)            │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. ЧИТАЮ HEARTBEAT.md                                          │
│     - Чеклист задач                                             │
│     - Напоминания                                               │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. ПРОВЕРКИ (ротация 2-4 раза в день)                          │
│     - Email (срочные сообщения?)                                │
│     - Календарь (события в ближайшие 24ч?)                      │
│     - Проекты (git status)                                      │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. РЕШЕНИЕ                                                     │
│     - Есть что сообщить? → Отправить сообщение                  │
│     - Ничего важного? → HEARTBEAT_OK (тихо)                     │
└─────────────────────────────────────────────────────────────────┘
```

### Когда сообщать

- ✅ Важное письмо пришло
- ✅ Событие в календаре через <2ч
- ✅ Что-то интересное нашёл
- ✅ Прошло >8ч с последнего сообщения

### Когда молчать

- ❌ Ночь (23:00-08:00)
- ❌ Пользователь занят
- ❌ Ничего нового с прошлой проверки
- ❌ Проверял <30 минут назад

### Файлы системы

| Файл                          | Назначение         |
| ----------------------------- | ------------------ |
| `HEARTBEAT.md`                | Чеклист задач      |
| `memory/heartbeat-state.json` | Состояние проверок |

---

## 🔄 Git Sync (`/git`)

### Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM: /git                               │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. cd ~/Clowdbot                                               │
│  2. git pull origin main                                        │
│  3. git status --short                                          │
│  4. git add -A                                                  │
│  5. git commit -m "<auto message>"                              │
│  6. git push origin main                                        │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  РЕЗУЛЬТАТ:                                                     │
│  ✅ Pushed to main                                              │
│  📝 Commit: abc123                                              │
│  📁 Файлы: список изменённых                                    │
└─────────────────────────────────────────────────────────────────┘
```

### Синхронизация

```
Telegram → /git → GitHub ← git pull ← Mac/Cursor
```

### Файлы системы

| Файл                                   | Назначение             |
| -------------------------------------- | ---------------------- |
| `~/.openclaw/skills/git-sync/SKILL.md` | Skill команды          |
| `~/Clowdbot/`                          | Репозиторий на сервере |

---

## 🗂️ Очистка файлов Mac

### Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM: "Наведи порядок в загрузках"       │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. СОЗДАНИЕ БЭКАПА                                             │
│     ~/.openclaw/cleanup-scripts/start-cleanup.sh downloads      │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. АНАЛИЗ ФАЙЛОВ                                               │
│     - Сканирование ~/Downloads                                  │
│     - Группировка по типам (.dmg, .zip, дубликаты)              │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. ПОДТВЕРЖДЕНИЕ                                               │
│     "Удалить 12 .dmg файлов (3.2 GB)? (да/нет)"                 │
│     → Ждёт ответа пользователя                                  │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. ВЫПОЛНЕНИЕ + ЗАВЕРШЕНИЕ                                     │
│     - Удаление файлов                                           │
│     - confirm-cleanup.sh или rollback-cleanup.sh                │
└─────────────────────────────────────────────────────────────────┘
```

### Разрешённые папки

- `~/Downloads`
- `~/Desktop`
- `~/Documents`
- `~/Pictures`

### Файлы системы

| Файл                                | Назначение           |
| ----------------------------------- | -------------------- |
| `~/.openclaw/agent-instructions.md` | Правила безопасности |
| `~/.openclaw/cleanup-scripts/`      | Скрипты очистки      |
| `~/.openclaw/exec-approvals.json`   | Allowlist команд     |

---

## 📊 Сводка всех cron jobs

| Job                            | Расписание    | Тип      | Модель                 | Описание             |
| ------------------------------ | ------------- | -------- | ---------------------- | -------------------- |
| Утренний брифинг               | 06:00         | isolated | llama-3.3-70b-free     | Персональный брифинг |
| 🚨 BACKUP: Утренний брифинг    | 06:05         | isolated | gemini-3-flash-preview | Fallback брифинг     |
| Утренний дайджест @newsneiron  | 08:00         | isolated | llama-3.3-70b-free     | Новости              |
| 🚨 BACKUP: Утренний дайджест   | 08:05         | isolated | gemini-3-flash-preview | Fallback дайджест    |
| Утренние мнения                | 08:30         | isolated | llama-3.3-70b-free     | Мнения/комментарии   |
| 🚨 BACKUP: Утренние мнения     | 08:50         | isolated | gemini-3-flash-preview | Fallback мнения      |
| Дневной дайджест @newsneiron   | 13:00         | isolated | llama-3.3-70b-free     | Новости              |
| 🚨 BACKUP: Дневной дайджест    | 13:05         | isolated | gemini-3-flash-preview | Fallback дайджест    |
| Дневные мнения                 | 13:30         | isolated | llama-3.3-70b-free     | Мнения/комментарии   |
| 🚨 BACKUP: Дневные мнения      | 13:50         | isolated | gemini-3-flash-preview | Fallback мнения      |
| Вечерний дайджест @newsneiron  | 18:00         | isolated | llama-3.3-70b-free     | Новости              |
| 🚨 BACKUP: Вечерний дайджест   | 18:05         | isolated | gemini-3-flash-preview | Fallback дайджест    |
| Вечерние мнения                | 18:30         | isolated | llama-3.3-70b-free     | Мнения/комментарии   |
| 🚨 BACKUP: Вечерние мнения     | 18:50         | isolated | gemini-3-flash-preview | Fallback мнения      |
| Ежедневная рефлексия           | 20:30         | main     | —                      | Рефлексия + вопросы  |
| 🧹 Chat Cleanup                | 21:00         | main     | —                      | Очистка контекста    |
| Auto-commit: Git sync          | каждые 4ч     | isolated | llama-3.3-70b-free     | Автосинхронизация    |
| 🚨 BACKUP: Git sync            | каждые 4ч+30м | isolated | gemini-3-flash-preview | Fallback git sync    |
| Аводарт — напоминание          | Вс 09:00      | main     | —                      | Приём Аводарта       |
| Еженедельный анализ источников | Вс 10:00      | main     | —                      | Exploration анализ   |
| Авиценна — ежемесячный вес     | 28-е 08:00    | main     | —                      | Вес + здоровье       |

> **Модель BACKUP jobs:** `google/gemini-3-flash-preview` — fallback когда основная (llama free) недоступна или медленна.
> **sessionTarget main** — событие ставится в очередь главному агенту (модель агента, не payload).
> **sessionTarget isolated** — запускается изолированный агент с явно указанной моделью.

### Управление cron jobs

```bash
# Список всех jobs
openclaw cron list

# История выполнений конкретного job
openclaw cron runs --id <job-id>

# Принудительный запуск
openclaw cron run <job-id> --force

# Отключить job
openclaw cron disable <job-id>

# Изменить расписание / модель
openclaw cron edit <job-id> --cron "0 9 * * *"
openclaw cron edit <job-id> --model anthropic/claude-sonnet-4-6
```

### Надёжность cron

- **Catch-up при рестарте** — при старте gateway автоматически выполняет пропущенные jobs
- **Таймер max 60s** — scheduler просыпается не реже раза в минуту (защита от дрейфа)
- **Exponential backoff** — при ошибках: 30s → 1m → 5m → 15m → 60m
- **Re-arm при занятом scheduler** — если job выполняется >60s, таймер переносится (не теряется)
- **Таймаут job** — isolated jobs: настраивается через `--timeout-seconds` (default 10m)
- **BACKUP jobs** — срабатывают через 5-20 мин после основного, используют другую модель (gemini-3-flash-preview)

---

_Последнее обновление: 2026-02-21_
